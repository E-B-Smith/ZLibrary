#!/bin/bash

#  subtree  -  Pulls or pushes a git subtree.
#  EB Smith, January 2015

function usage() {
cat <<USAGE
subtree  -  Pulls or pushes a git subtree.

Usage:  subtree [ pull | push | -h ]

USAGE
}

set -eu -o pipefail
scriptpath="$( cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

if (( $# == 0 )); then
    echo ">>> Error: Option expected." 1>&2
    exit 1
    fi

case "$1" in
    -h)     usage; exit 0 ;;
    pull)   verb="pull"; option="--squash" ;;
    push)   verb="push"; option="" ;;
    *)      echo ">>> Error: Unknown option '$1'." 1>&2; exit 1 ;;
    esac

shift
if (( $# != 0 )); then
    echo ">>> Error: Extraneous option '$1'." 1>&2
    exit 1
    fi

gitpath=
while true; do
    # pwd
    node=$(basename `pwd`)
    if [[ -d ./.git ]]; then
        gitpath=${gitpath%%/}
        git subtree $verb --prefix="$gitpath" $option ZLibrary master
        exit 0
    else
        gitpath="$node"/"$gitpath"
        if ! cd ..; then
            echo ">>> Can't find the git parent directory." 1>&2
            exit 1
            fi
        fi
    done
